import Page from "@reason/pages/Docs";
import DocLink from "@reason/components/DocLink"
export default Page({ title: "Staking Service Guidelines" });

# Рекомендации по стейкингу

Важной частью работы стейкинга является предсказание/определение выигравших слотов, в которых вы можете создавать блоки, и производить выплаты участникам. Протокол Mina не выполняет выплаты вознаграждений делегатам автоматически, поэтому часть работы стекингового сервиса - это произведение выплат участникам вручную.

Этот документ описывает компоненты, о которых вам следует знать при управлении этими выплатами. В частности, статья дает понимание о шансах на выигрыш блоков, сбор данных из реестра для дальнейшего использования и вычисление соответствующей информации о стейкинговых выплатах на основе этих данных.

## Награда за стейкинг

Вознаграждение за создание блока составляет 720 токенов. Однако некоторые аккаунты получат двукратное увеличенное вознаграждение, если содержат только разблокированные токены. В случае делегирования, увеличено ли вознаграждение или нет зависит от аккаунта, выигравшего блок, а не от аккаунта, который занимается стейкингом и производством блоков.

## Дампы стейкингового реестра

Чтобы вычислить шансы на выигрыш блока для данной эпохи или постфактум вычислить общее вознаграждение, которое получит определенный аккаунт, вам необходимо иметь реестр стейкинга для этой эпохи. Mina daemons хранят только реестр стейкинга для текущей и следующей за ней эпохи, поэтому, если вы хотите сохранить стейкинговый реестр для конкретной эпохи, вам нужно сделать это до или во время этой эпохи.

Команда `mina ledger export` может использоваться для экспорта реестров из запущенного daemon. В качестве аргумента он принимает идентификатор реестра, который вы хотите экспортировать. В таблице ниже описано, что представляет каждый из этих идентификаторов. 

| Идентификатор        | Описание                                                        |
|----------------------|-----------------------------------------------------------------|
| staking-epoch-ledger | Реестр стейкинга текущей эпохи.                                 |
| next-epoch-ledger    | Реестр стейкинга для следующей эпохи (эпохи после текущей).     |
| staged-ledger        | Самый последний staged ledger (из best tip этой ноды).          |

<!-- insert breakpoints to space out table -->
<br /> <br />

Чтобы каждый реестр стейкинга всегда был доступен к использованию по истечению эпох, мы рекомендуем экспортировать реестр стейкинга каждые $\dfrac{7140\times3}{60} = 357$ часов ($7140$ слотов за эпоху, каждый слот длится $3$ минуты). 

По умолчанию реестры экспортируются в виде данных json. Смотрите `mina ledger export -help`, чтобы получить документацию по флагам, включающих другие форматы. При выводе в формате json реестр будет представлен в виде множества объектов учетной записи. Ниже приведен пример того, как выглядит объект учетной записи в json. 

```json
{
  "pk": "B62qrwZRsNkU39TrGpFwDdpRS2JaCB2yFZKMFNqLFYjcqGE5G5fWA8p",
  "balance": "17000",
  "delegate": "B62qrwZRsNkU39TrGpFwDdpRS2JaCB2yFZKMFNqLFYjcqGE5G5fWA8p",
  "token": "1",
  "token_permissions": {},
  "receipt_chain_hash": "2mzbV7WevxLuchs2dAMY4vQBS6XttnCUF8Hvks4XNBQ5qiSGGBQe",
  "voting_for": "3NK2tkzqqK5spR2sZ7tujjqPksL45M3UUrcA4WhCkeiPtnugyE2x",
  "permissions": {
    "stake": true,
    "edit_state": "signature",
    "send": "signature",
    "set_delegate": "signature",
    "set_permissions": "signature",
    "set_verification_key": "signature"
  }
}
```

Для осуществления стейкинга вам должны быть интересны аккаунты, которые вы контролируете, и аккаунты, которые осуществляют стейкинг в аккаунты, которые вы контролируете. Например, если бы в нашем стейкинг-сервисе участвовал только один аккаунт, мы могли бы присвоить все аккаунты, в которых мы заинтересованы, реестру, используя такую команду: 

```sh
mina ledger export staking-epoch-ledger | jq "$(cat <<EOF
  .[] | \
  select( \
    .pk == "B62qjwvvHoM9RVt9onMpSMS5rFzhy3jjXY1Q9JU7HyHW4oWFEbWpghe" or \
    .delegate == "B62qjwvvHoM9RVt9onMpSMS5rFzhy3jjXY1Q9JU7HyHW4oWFEbWpghe" \
  )
EOF
)"
```

Рассчитывая выплаты, важно знать, будет ли аккаунт получать вознаграждения суперчардж за coinbase, которую вы, вероятно, захотите включить в коэффициент взвешивания стейкинг-сервиса при выплате участникам. Аккаунты с заблокированными токенами (являющиеся аккаунтами, которые *не* получают вознаграждения суперчардж за стейкинг) будут иметь специальное поле `"timing"` в образе json. Например, это может выглядеть так: 

```json
{
  "pk": "B62qmVHmj3mNhouDf1hyQFCSt3ATuttrxozMunxYMLctMvnk5y7nas1",
  "balance": "230400",
  "delegate": "B62qk2ujo9BoBxCs9BFQUsv3efaJDzbJeLs4YJdZMJzJoVj69ShVdKs",
  "timing": {
    "initial_minimum_balance": "230400",
    "cliff_time": "86400",
    "cliff_amount": "230400",
    "vesting_period": "1",
    "vesting_increment": "0"
  }
}
```

Если в аккаунте есть поле `"timing"`, это необязательно означает, что в аккаунте находятся заблокированные токены. Временне аккаунты содержат заблокированные и разблокированные токены, а поле `"timing"` описывает график разблокировки заблокированных токенов в этом аккаунте. Если в аккаунте есть поле `"timing"`, вы можете вычислить глобальный слот, в котором токены этого аккаунта будут полностью разблокированы, после чего аккаунт получит суперчардж-вознаграждения. Это можно вычислить, определив, сколько времени потребуется временному аккаунту, чтобы полностью осуществить вестинг своих токенов, и добавив это к `"cliff_time"`, то есть слоту, в котором аккаунт начинает вестинг токенов. Например, Python вычислит время этой разблокировки на основе информации о времени аккаунта. 

```python
vesting_amount = initial_min_balance - cliff_amount
vesting_time = vesting_amount * math.ceil(vesting_period / vesting_increment)
unlocked_time = cliff_time + vesting_time
```

## Выбор способа выплаты вознаграждения 

Каждый, кто обеспечивает стейкинг-сервис, определяет, как рассчитать вознаграждение. Вам необходимо принимать во внимание чрезмерную нагрузку и вес различных делегатов, в зависимости от того, как вы решите выплачивать вознаграждения. 

Мы рекомендуем просмотреть документ, составленный участником нашего сообщества на [docs.minaexplorer.com](https://docs.minaexplorer.com/minaexplorer/calculating-payments), чтобы понять, как рассчитывать выплаты за стейкинг-сервис.  

## Шансы на выигрыш блока 

Блоки в Mina создаются в определенные промежутки времени, которые называются "слотами". Каждый аккаунт в реестре имеет шанс выиграть каждый слот в сети, что позволяет им создавать блок для этого слота (или, в случае делегирования, позволяет делегированному аккаунту создавать блок от их имени). Аккаунт вычисляет случайное число (с помощью [проверяемой случайной функции или VRF](https://en.wikipedia.org/wiki/Verifiable_random_function)) для каждого слота и сравнивает это случайное число с требуемым порогом, чтобы определить, "выиграли" ли они этот слот и могут ли произвести блок в это время. Таким образом, их шанс выиграть слот определяется порогом, который является функцией их относительной доли в сети. 

Распределение стеков, которое определяется при выявлении порогового значения VRF, содержится в специальном реестре, который называется "реестр стейкинга" или "staking ledger". Реестр стейкинга – это фиксированные реестры прошлых эпох в сети (эпохи – это фиксированные промежутки слотов; каждая эпоха длится 7140 слотов). Использование прошлых фиксированных реестров не позволяет злоумышленникам увеличить свои шансы на выигрыш в течение эпохи, изменяя распределение стека в основном рееестре ("staged ledger"). Каждую эпоху реестр стейкинга меняется. Из-за этого ограничения любой аккаунт в системе может проверять только "выигрышные слоты" в течение следующих 2 эпох в любой момент времени. 

После того, как вы узнали о реестре стейкинга, который будет использоваться для данной эпохи, можно вычислить необходимый порог VRF для создания блоков в эту эпоху для каждого аккаунта. Мы можем вычислить коэффициент стека для данного аккаунта, разделив долю, контролируемую аккаунтом в реестре стейкинга, на общую сумму валюты в реестре стейкинга. На рисунке 1 на странице 20 в документе [Ouroboros Genesis](https://eprint.iacr.org/2018/378.pdf) представлена сырая функция для вычисления пороговых значений VRF. Заполнение значения Mina для коэффициента активных слотов $f$ дает нам следующую функцию: $\phi\left(\alpha\right) \triangleq 1 - \left(\dfrac{1}{4}\right)^\alpha$. Эта функция берется в качестве параметра $\alpha$ – коэффициента стека, вычисляемого для аккаунта. 

Поскольку каждый VRF сравнивается с этим порогом (который находится между 0 и 1), и каждый VRF – псевдослучайное число от 0 до 1, порог VRF для данного аккаунта по сути является вероятностью того, что слот будет выигран этим аккаунтом. Таким образом, мы можем экстраполировать эту функцию для вычисления пороговых значений VRF, чтобы определить среднее количество блоков, по которым, как мы можем ожидать, выиграет данный аккаунт в течение эпохи. Это можно определить, просто суммируя все вероятности выигрыша каждого слота эпохи, и, поскольку вероятность для всей эпохи фиксирована, математическое выражение для вычисления этого упрощается до $\phi\left(\alpha\right)\times7140$.

В качестве примера предположим, что в сети есть аккаунт, на котором содержатся токены mina на сумму $10^6$ (1 миллион) в эпоху ресстра стейкинга $ep$. Тот же реестр стейкинга для эпохи $ep$ имеет общее предложение токенов mina в размере $8\times10^8$ (800 миллионов). Мы можем вычислить шансы, что этот аккаунт выиграет отдельный слот в $ep$, используя $\phi\left(\dfrac{10^6}{8\times10^8}\right) = 0.0017313674$. Это дает нам шанс $\sim0.17\%$, что этот аккаунт выиграет каждый слот в эпоху $ep$. Затем мы можем вычислить среднее количество блоков, которые, как мы ожидаем, этот аккаунт создаст для этой эпохи, умножив результат на $7140$, что даст нам вероятностное среднее значение $\sim12.36$ блоков для эпохи. 
