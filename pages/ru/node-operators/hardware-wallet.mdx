import Page from "@reason/pages/Docs";
import DocLink from "@reason/components/DocLink";
export default Page({ title: "Hardware Wallet" });

# Аппаратный кошелек

Теперь Mina поддерживает использование аппаратных кошельков, таких как Ledger, для взаимодействия с протоколом и подписи транзакций.

<Alert kind="warning">

Дисклеймер: Поддержка Ledger является экспериментальной. Не используйте ее на устройстве Ledger, которое обрабатывает или когда-либо обрабатывало закрытые ключи, связанные с любыми аккаунтами, представляющими ценность.

</Alert>

## Требования

**Програмное обеспечение**: Linux (На данный момент поддерживает Debian 9 и Ubuntu 18.04 LTS)

Примечание: В настоящее время официальная поддержа для MacOS и Windows отсутствует.

**Аппаратное обеспечение**: В настоящее время поддерживается только [Ledger Nano S](https://shop.ledger.com/products/ledger-nano-s)

## Установка

**Дисклеймер**: Поддержка все еще экспериментальная -- используйте с осторожностью, так как данные инструкции могут измениться. Как только приложение кошелька станет доступно на [Ledger Live](https://www.ledger.com/ledger-live), этапы установки будут стандартизированы.

Для использования аппаратных кошельков в Linux необходимы следующие пакеты debian:

```
sudo apt install libusb-1.0-0-dev libudev1 libudev-dev
```

### Убедитесь, что ваш компьютер распознает устройство Ledger

- Подключите устройство Ledger, разблокируйте его с помощью вашего пароля и перейдите в меню. Не открывайте никаких приложений,
- Запустите `lsusb` и посмотрите, есть ли устройство в списке -- оно будет иметь ID `2c97:0001`
- Если устройства Ledger нет в списке, следуйте рекомендациям
  [здесь](https://support.ledger.com/hc/en-us/articles/115005165269-Fix-connection-issues).

### Установите python загрузчик приложений

Загрузчик приложений python для Ledger находится [здесь](https://github.com/LedgerHQ/blue-loader-python)
и может быть загружен/установлен следующим образом:

```
sudo apt install -y libudev-dev libusb
pip3 install ledgerblue
```

При работе в Linux после установки убедитесь, что следующие правила
добавлены в `/etc/udev/rules.d/` (например, с помощью `sudo vim /etc/udev/rules.d/20-hw1.rules`),
изменяющие `<UNIX username>` на ваше имя пользователя unix:

```
SUBSYSTEMS=="usb", ATTRS{idVendor}=="2c97", ATTRS{idProduct}=="0000", MODE="0660", TAG+="uaccess", TAG+="udev-acl" OWNER="<UNIX username>"
SUBSYSTEMS=="usb", ATTRS{idVendor}=="2c97", ATTRS{idProduct}=="0001", MODE="0660", TAG+="uaccess", TAG+="udev-acl" OWNER="<UNIX username>"
SUBSYSTEMS=="usb", ATTRS{idVendor}=="2c97", ATTRS{idProduct}=="0004", MODE="0660", TAG+="uaccess", TAG+="udev-acl" OWNER="<UNIX username>"
```

### Соберите/загрузите приложение Ledger для Mina

Либо загрузите скомпилированный файл приложения
[здесь](https://github.com/MinaProtocol/ledger-mina-app/releases/tag/v0.1.0), либо следуйте инструкциям
в конце этого документа, чтобы самостоятельно <DocLink copy="собрать приложение из исходников" url="/hardware-wallet#building-from-source" />.

Чтобы загрузить скомпилированное приложение на устройство Ledger, после скачивания `ledger-precompile.zip`
по ссылке выше перейдите в каталог, в котором находится `ledger-precompile.zip` и выполните следующее:

```
unzip ledger-precompile.zip
cd ledger-precompile
./load.sh
```

Чтобы удалить приложение, вы можете выполнить

```
./delete.sh
```

# Использование аппаратного кошелька

Инструмент командной строки аппаратного кошелька mina - это пакет Python под названием `mina-ledger-cli`:

```
python3 -mpip install mina-ledger-cli==0.0.5
```

Если у вас есть проблемы с подключением к аппаратному кошельку, пожалуйста, ознакомьтесь со
[справкой по устранению неполадок на странице поддержки Ledger](https://support.ledger.com/hc/en-us/articles/115005165269-Fix-connection-issues).
Часто проблемы с подключением можно решить, добавив правила udev. Введите
следующую команду для автоматического добавления правил и перезагрузки udev:

```
wget -q -O - https://raw.githubusercontent.com/LedgerHQ/udev-rules/master/add_udev_rules.sh | sudo bash
```

## Создайте новый аккаунт

Выполните следующую команду, которая создаст пару из открытого и закрытого ключей в аппаратном кошельке:

    mina accounts create-hd HD-index

HD-индекс - это число, которое работает как сид-фраза, которую вы задаете аппаратному кошельку
для создания вашей пары из открытого и закрытого ключей. Если вы используете тот же HD-индекс с
одним и тем же аппаратным кошельком дважды, сгенерируемая пара открытого и закрытого ключей
останется той же. Если вы хотите воспользоваться тем же аккаунтом на другом компьютере, вам
просто нужно использовать эту команду с тем же HD-индексом и тем же аппаратным кошельком.

Во время создания аккаунта ваш аппаратный кошелек может попросить вас подтвердить операцию.

Ответ этой команды будет выглядеть так:

    Keypair generated
    Public key:  B62qrPN5Y5yq8kGE3FbVKbGTdTAJNdtNtB5sNVpxyRwWGcDEhpMzc8g

Поскольку открытый ключ достаточно длинный и его сложно запомнить, сохраним его как
переменную среды:

    export MINA_PUBLIC_KEY=<YOUR-PUBLIC-KEY>

Теперь мы можем получить доступ к ней как `$MINA_PUBLIC_KEY` -- удостоверьтесь, что она сохранилась
правильно, используя команду `echo $MINA_PUBLIC_KEY`.

## Совершите платеж

Вы можете использовать те же команды для отправки платежей, что и в

<DocLink copy="документы" url="/node-operators/send-payment#make-a-payment" />

Есть 2 различия:

1. Вам не нужно разблокировать свою учетную запись перед отправкой транзакции, потому что
   ваш аккаунт уже защищен аппаратным кошельком.
2. Ваш аппаратный кошелек может попросить вас подтвердить операцию при подписании
   транзакции.

## Устранение неполадок

### Что если я потеряю свой аппаратный кошелек?

Вы можете купить еще один `Ledger Nano S` и запустить его при помощи той же сид-фразы из 24 слов,
чтобы получить доступ к вашему существующему аккаунту.

### Что если я забуду открытый ключ моего аккаунта?

Если вы помните HD-индекс, который использовался для создания учетной записи, то вы
может использовать `mina accounts create-hd HD-index` с тем же HD-индексом для повторной генерации
открытого ключа.

## Сборка из исходников

Для сборки приложения Ledger из исходников требуется установка версий gcc и clang.
Это можно сделать двумя способами: вы можете установить их с помощью `sudo apt install gcc clang`,
или загрузить предварительно скомпилированные версии clang и gcc, а затем добавить их
в вашу `PATH`.

### Загрузка скомпилированных gcc и clang

Согласно инструкциям в [Ledger Wiki](https://ledger.readthedocs.io/en/latest/userspace/getting_started.html):

- Установите стандартный gcc (для прошивки микроконтроллера и безопасного подключения устройств)
  !!!!!(link from ledger link?)!!!!!, загрузив скомпилированный двоичный файл
  [здесь](https://developer.arm.com/tools-and-software/open-source-software/developer-tools/gnu-toolchain/gnu-rm/downloads)
- Установите стандартный clang с поддержкой ROPI (для приложений с защищенным процессором),
  следуя инструкциям [здесь](https://clang.llvm.org/get_started.html), чтобы
  собрать из исходников или загрузить предварительно скомпилированный файл.
- После загрузки двоичных файлов разархивируйте и установите их, например, с помощью
  ```
  cd Downloads
  tar -xf clang+llvm-7.0.0-x86_64-linux-gnu-ubuntu-16.04.tar.xz
  bzip2 -dk gcc-arm-none-eabi-5_3-2016q1tar.bz2
  ```
  и затем добавьте их в свою PATH с помощью
  ```
  # GCC
  PATH=~/bolos-devenv/gcc-arm-none-eabi-5_3-2016q1/bin:$PATH
  # Clang
  PATH=~/bolos-devenv/clang+llvm-7.0.0-x86_64-linux-gnu-ubuntu-16.04/bin:$PATH
  ```

Далее, для установки требуемых заголовков кросс-компиляции, используйте:

```
sudo apt install gcc-multilib g++-multilib
```

Затем установите Nano S SDK с помощью

```
git clone git@github.com:LedgerHQ/nanos-secure-sdk.git
```

и добавьте `export BOLOS_SDK=<PATH-TO-SDK>` в ваш `~/.bashrc` или `~/.profile`.

### Соберите и загрузите приложение Mina для Ledger

Выполнение следующей команды установит приложение Mina на ваше устройство Ledger:

```
git clone git@github.com:MinaProtocol/ledger-mina-app.git
cd ledger-mina-app
git checkout 4574d3c
make load
```
