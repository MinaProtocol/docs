import Page from "@reason/pages/Docs";
import DocLink from "@reason/components/DocLink";
export default Page({ title: "Scan State" });

# Scan State

Scan state - это структура данных, которая позволяет разграничить производство SNARK-транзакций блок-продюсеров и снарк-воркеров.

Поскольку блок-продюсерам больше не нужно проводить SNARK-транзакции, время производства блока может оставаться постоянным независимо от пропускной способности транзакции. Кроме того, scan state позволяет распараллеливание генерации доказательств SNARK-транзакций и выполнение ее несколькими конкурирующими <DocLink copy="снарк-воркерами" url="/architecture/snark-workers" />.

Scan state – это лес, состоящий из [полных бинарных деревьев](https://en.wikipedia.org/wiki/Binary_tree), где каждая нода на дереве - это задача, которую должен выполнить снарк-воркер. Время от времени scan state возвращает одно доказательство с верхушки дерева для подтверждения правильности всех транзакции в основе дерева.

Блок-продюсеры включают доказательства реестра в SNARK блокчейн, который они генерируют, что доказывает валидность текущего состояния цепочки и подтверждает достоверность всех транзакций в снарк-реестре.

Как результат, время производства блока может оставаться постоянным независимо от пропускной способности транзакции, при этом структура scan state способна приспосабливаться в соответствии с желаемой пропускной способностью транзакции.

<Alert>

В устойчивом состоянии, когда все слоты заполнены, и все необходимые доказательства выполнены, с каждым блоком будет производиться подтверждение реестра.

</Alert>

### Добавление транзакций

При построении блока <DocLink copy="блок-продюсер" url="/architecture/block-producers" /> может включать максимальное количество транзакций, обозначенное [константами scan state](#scan-state-constants). Добавляя транзакции, он может выбирать любую доступную комиссию за транзакции и выплачивать себе вознаграждение в монетах. Каждая добавленная транзакция преобразуется в новые базовые задачи и добавляется в scan state.

Для каждой добавленной транзакции блок-продюсер должен включить эквивалентное количество завершенной снарк-работы, соответствующее череде заданий, которые уже существуют в scan state. При добавлении в scan state завершенные задачи создают новые задачи слияния. Но в случае с корневой нодой доказательство просто возвращается.

Вместо того, чтобы выполнять работу самостоятельно, блок-продюсер может приобрести завершенную работу у любых снарк-воркеров среди ставок, доступных в снарк-пуле.

### Константы scan state

Следующие константы определяют структуру и поведение scan state:

- transaction_capacity_log_2
- work_delay

Константа transaction_capacity_log_2 определяет максимальное количество транзакций, которое может быть включено в блок:

```
max_no_of_transactions = 2^{transaction_capacity_log_2}
```

Задержка работы обеспечивает достаточное количество времени на выполнение работы снарк-воркерами. Если готовые доказательства отсутствуют, ,kjr-ghjl.cth не может добавить какие-либо транзакции. Благодаря отложенному выполнению работы максимальное количество деревьев, которые могут существовать в scan state определяется следующей формулой:

```
max_number_of_trees = (transaction_capacity_log_2 + 1) * (work_delay + 1) + 1
```

Максимальное количество доказательств, которые могут быть включены в блок, определяется следующей формулой:

```
max_number_of_proofs = 2^{transaction\_capacity_log_2 + 1} - 1
```

Ограничители scan state гарантируют, что для каждого блока может быть выпущено только одно доказательство, и что нода слияния, которая будет обновлена после добавления доказательств, соответствующих ее дочерним элементам, всегда пуста.

Хотя максимальное количество транзакций может быть фиксированным, оно также может динамически регулироваться, чтобы соответствовать пропускной способности транзакции. Таким образом, scan state может обрабатывать неограниченное количество транзакций, правда за счет увеличения (логарифмически) задержки подтверждения транзакции.

### Примеры

Рассмотрим scan state с `max_no_of_transactions = 4`, и `work_delay = 1`. Из этого вытекает, что максимальное количество выполняемой работы может быть равно 7, а максимальное количество деревьев - 7. В **генезисе** состояние scan state – пустое.

<img
  alt="Block 0"
  src="/static/img/docs-images/scan-state/ZJXLozR.png"
  width="350"
/>

**Блок 1**: Производитель блока вносит четыре транзакции в scan state с меткой `B1`. Эти транзакции заполняют основу первого дерева.

<img
  alt="Block 1"
  src="/static/img/docs-images/scan-state/mY4MzW0.png"
  width="350"
/>

**Блок 2**: Во втором блоке производитель блока добавляет еще четыре транзакции (`B2`). Они заполняют основу второго дерева. Доказательств не требуется из-за задержки работы блока 1.

<img
  alt="Block 2"
  src="/static/img/docs-images/scan-state/jzYrmZf.png"
  width="700"
/>

**Блок 3**: В третьем блоке блок-продюсер добавляет четыре транзакции `B3` к третьему дереву и должен включать четыре доказательства для первого дерева. В результате включения этих завершенных базовых доказательств создаются две новые задачи слияния `M3`.

<img
  alt="Block 3"
  src="/static/img/docs-images/scan-state/tECFm3I.png"
  width="100%"
/>

<Alert>

`B` или `M` обозначают базовое задачи или задачи слияния, а число указывает порядок добавления в scan state.

</Alert>

**Блок 4**: Для четвертого блока производитель блока добавляет еще четыре транзакции (`B4`) в основу четвертого дерева. Они должны включать четыре доказательства, соответствующих работе, добавленной в блоке 2. Опять-таки, в результате создаются две задачи слияния `M4`.

<img
  alt="Block 4"
  src="/static/img/docs-images/scan-state/76R2bpU.png"
  width="100%"
/>

<Alert>

Любая незавершенная задача (оранжевый индикатор) - это работа снарк-воркеров. Снарк-воркеры отправляют завершенную работу в снарк-пул. Задача может быть выполнена несколькими снарк-воркерами, но производители блоков могут приобрести только наименьшую награду в снарк-пуле.

</Alert>

**Блок 5**: В пятый блок добавляются еще четыре транзакции заполняя базу пятого дерева (`B5`), вместе с еще шестью доказательствами (`B3`s and `M3`s). Задачи слияния `M3` вытекают в финальную отсроченную задачу слияния для первого дерева (`M5`).

<img
  alt="Block 5"
  src="/static/img/docs-images/scan-state/QaqfbXG.png"
  width="100%"
/>

**Блок 6**: В шестой блок добавляются еще четыре транзакции (`B6`), заполняя основу шестого дерева. Вносятся еще шесть доказательств (`B4` and `M4`), и создаются три новых задания слияния (`M6`).

<img
  alt="Block 6"
  src="/static/img/docs-images/scan-state/y6dM2FT.png"
  width="100%"
/>

**Блок 7**: В седьмой блок блок-продюсер добавляет еще четыре транзакции (`B7`), заполняя основу седьмого дерева, и это максимальное количество деревьев, согласно с указанными константами scan state. Добавляется максимальное количество (7) доказательств (`B5` and `M5`). Эти доказательства создают три новых задания слияния (`M7`), а верхнее доказательство `M5` выводится из scan state.

<img
  alt="Block 7"
  src="/static/img/docs-images/scan-state/RY8umxW.png"
  width="100%"
/>

Доказательство, которое производит первое дерево, является доказательством реестра, которое соответствует транзакциям добавленным в блоке 1. Затем содержимое дерева удаляется, чтобы освободить место для дополнительных транзакций.

<img
  alt="Emit proof"
  src="/static/img/docs-images/scan-state/hQvFVfp.png"
  width="100%"
/>

**Блок 8**: В восьмом блоке производитель блоков добавляет две транзакции (`B8`) и включает 4 (`B6`) доказательства. Эти доказательства вытекают в два новых задания слияния (`M8`). Обратите внимание, что для добавления двух транзакций требуется только четыре доказательства.

<img
  alt="Block 8"
  src="/static/img/docs-images/scan-state/A3o18oN.png"
  width="100%"
/>

<Alert>

Работа снарка объединяется в рабочий пакет, обычно содержащий два рабочих идентификатора, за исключением финального корневого доказательства дерева. Пропорциональная работа для транзакции требует два доказательства. Это гарантирует равенство включенных транзакций и приобретаемой работы снарка.

</Alert>

**Блок 9**:
Блок 9: В девятом блоке производитель блоков добавляет три транзакции (`B9`). Чтобы занять слоты в незаполненном дереве необходимо три доказательства (`M6`). В предыдущий блок было добавлено четыре доказательства, следовательно требуется лишь три доказательства (учитывая, что максимальная работа - 7). Доказательство `M6`из второго дерева возвращается в виде доказательства реестра. Третья `B9` транзакция переходит в уже пустое дерево, и добавляются два доказательства `B7`.

<img
  alt="Block 9"
  src="/static/img/docs-images/scan-state/JGlawxh.png"
  width="100%"
/>

**Блок 10**: В десятом блоке производитель блоков добавляет четыре транзакции и в итоге включает семь доказательств (`B7`, `M7`, и два `B8`s).

<img
  alt="Block 10"
  src="/static/img/docs-images/scan-state/kQASfTN.png"
  width="100%"
/>

**Блок 11**: В одиннадцатом блоке производитель блоков добавляет три транзакции (`B11`) и включает пять доказательств (`B9`, `B9`, `M8`, `M8`, `M9`) в указанном порядке. Кроме того, доказательство реестра `M9` возвращается из четвертого дерева.

<img
  alt="Block 11"
  src="/static/img/docs-images/scan-state/FaVTmWD.png"
  width="100%"
/>

<Alert>

Просмотрите содержимое scan state с помощью расширенной команды `mina advanced snark-job-list`.

</Alert>

### Интеграция в снарк-пул

Новые задания, добавленные в scan state, – это отсроченная работа для снарк-воркеров. Снарк-воркеры выполняют требуемые SNARK-транзакции и делают ставки за выполненную работу. Когда нода получает и валидирует выполненную работу, она добавляет ее в свой локальный снарк-пул вместе с минимальной оплатой за требуемую работу. О работе также станет известно другим пирам в сети.

<Alert>

Хотя одну и ту же работу могут выполнять несколько снарк-воркеров, в снарк-пул добавляется лишь та, которая имеет наименьшую оплату.

</Alert>

Когда производитель блоков включает завершенные доказательства в блок для компенсации каких-либо добавленных транзакций, он может приобрести соответствующую работу в снарк-пуле. Вернемся к приведенному выше примеру о блоке (12). Если производитель блоков хочет добавить в снарк-воркер три транзакции, включая монетное вознаграждение, платеж пользователя и комиссию за перевод, ему необходимо приобрести три завершенных работы снарка. Это соответствует 6 `B9`, `B10`s, `M9`, и `M10` доказательствам (из седьмого дерева), поскольку каждая работа снарка включает в себя два _workIds_.

Во время создания блока, снарк-пул может включать в себя завершенную работу вместе с лучшими ставкам за необходимые задания (0.025, 0.165, 0.1 и 0.5) соответственно, как в примере).

<img
  alt="Submitted work"
  src="/static/img/docs-images/scan-state/fDBZog9.png"
  width="100%"
/>

Блок-продюсер рассмотрит цену доступной работы перед выбором транзакций. Первой транзакцией, которую добавит блок-продюсер, будет монетарная транзакция, для которой предусмотрено вознаграждение в виде монетной базы. Если комиссия за транзакцию не покрывает комиссию снарк-воркеров, которая должна быть включена, то транзакция не будет добавлена. Блок-продюсер никогда не приобретет работу, если в этом нет выгоды.

В случае отсутствия выполненной снарк-работы, доступной для покупки в требуемом порядке, соответствующие транзакции в блок включены не будут. Это может привести к тому, что блок останется пустым. Но также в случае, когда ни одна транзакция не может быть добавлена (включая монетарные транзакции), производитель блока вознаграждение не получит.

<Alert>

Текущий снарк-пул отображается через <DocLink copy="GraphQL" url="/developers/graphql-api" /> или с помощью CLI, выполнив команду `mina advanced snark-pool`.

</Alert>
