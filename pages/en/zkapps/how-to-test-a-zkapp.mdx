import Page from "@reason/pages/Docs";
import DocLink from "@reason/components/DocLink";
export default Page({ title: "How to test a zkApp" });

# How to test a zkApp
Learn how to write automated tests for your smart contract.

Writing automated tests for your smart contract is of crucial importance. The <a href="https://jestjs.io/">Jest testing framework</a> is included in all projects created by the Mina zkApp CLI via `zk project <name>` and `zk example <name`. We recommend Jest, but any testing framework can be used.

### Running tests

To run all test files within your project, run `npm run test` or `npm run testw` (for watch mode) from your projectâ€™s root directory.

To generate a test coverage report for your project, run `npm run coverage`. Coverage reports show the % of your code that is tested. The result will be output in your terminal. This can be helpful to ensure your code is well tested.

### Writing tests

Creating tests for your smart contract is easy using the Mina zkApp CLI. To scaffold a TypeScript file with a corresponding test file, simply run the command `zk file foo`. This will generate two files, named `foo.ts` and `foo.test.ts`. `foo.test.ts` is a great place to start writing all your smart contract test code. To write good unit tests, it's vital that you concretely understand the functionality your smart contract provides. An example is shown below of a basic test written in Jest:

```ts
describe("foo.test.ts", () => {
  describe("test()", () => {
    // your test here
  });
});
```

Because we are using Jest, it's helpful to break down all functionality of your smart contract into `describe` blocks. Mapping out your unit tests like this is also a good way of providing documentation to other developers reading your smart contract. An excellent place to start testing your smart contract is in the areas your smart contract modifies its state. Make sure to verify that your state updates in the way you expect.

For examples of existing tests, we recommend creating a template example using the Mina zkApp CLI via `zk project <name>` and examining the test file there. [You will see a basic example of a few tests](https://github.com/o1-labs/zkapp-cli/blob/main/templates/project-ts/src/Add.test.ts) that deploy and update the state on a smart contract using Jest.

#### Creating a local blockchain

The `Mina.LocalBlockchain()` method specifies a mock Mina ledger of accounts that runs locally. It contains logic for updating the ledger that can be used to test your smart contract locally.

```ts
let Local = Mina.LocalBlockchain();
Mina.setActiveInstance(Local);
```

#### Deploying a contract locally

The mock Mina local blockchain contains test accounts that can be used to deploy the contract and pay transaction fees.

```ts
// test accounts that pays all the fees, and puts additional funds into the zkapp.
let feePayer = Local.testAccounts[0].privateKey;
```

We generate a zkApp account and a new instance of the smart contract to deploy locally for testing.

```ts
// zkapp account
let zkAppKey = PrivateKey.random();
let zkAppAddress = zkAppPrivateKey.toPublicKey();
let zkAppInstance = new Add(zkAppAddress);
```

Use the test account and zkApp keys to construct a transaction to pay account creation fees and deploy your smart contract. This transaction is sent to the local blockchain. 

```ts
let txn = await Mina.transaction(feePayer, () => {
  Party.fundNewAccount(feePayer);
  zkAppInstance.deploy({ zkappKey });
});
txn.send();
```

#### Writing integration tests

While Jest can be used to write both unit and integration tests, It is reccomended to create linear scripts for smart contract integration tests. The scripting worflow is easier to reason about when creating large interconnected tests. It also makes debugging easier and provides good error tracing. 


 A well written script tests the flow of your smart contracts expected behavior, and verifies correctness of state updates. After you test the expected behavior, it's benifical to verify the preconditions of your methods and test edge cases of your smart contract. Below is an example of a basic integration test script.

```ts
await isReady;
// setup local blockchain
let Local = Mina.LocalBlockchain();
Mina.setActiveInstance(Local);

// test accounts that pays all the fees, and puts additional funds into the zkapp.
let feePayer = Local.testAccounts[0].privateKey;

// zkapp account
let zkAppPrivateKey = PrivateKey.random();
let zkAppAddress = zkAppPrivateKey.toPublicKey();
let zkAppInstance = new Add(zkAppAddress);

// deploy zkapp
console.log('Deploying Add smart contract ...');
let tx = await Mina.transaction(feePayer, () => {
  Party.fundNewAccount(feePayer);
  zkAppInstance.deploy({ zkappKey: zkAppPrivateKey });
  zkAppInstance.init();
});

tx.send();

let currentState = zkAppInstance.num.get().toString();
console.log(`Initial state: ${currentState}`);

console.log('Updating state ...');
tx = await Mina.transaction(feePayer, () => {
  zkAppInstance.update();
  zkAppInstance.sign(zkAppPrivateKey);
});

tx.send();

currentState = zkAppInstance.num.get().toString();

if (currentState !== '3') {
  throw Error(`'State incorrectly updated to ${currentState}`);
}
console.log(`Current State: ${currentState}`);

shutdown();
``` 

### Learn more

Please see the <a href="https://jestjs.io/docs/getting-started">Jest docs</a> for further information on how to use Jest.

We will be adding blockchain-specific testing functionality in the future. Keep an eye on this section for updates.

## Next Steps

Now that you've learn how to test a smart contract, you can now learn <DocLink copy="how to deploy your zkApp" url="/zkapps/how-to-deploy-a-zkapp" />.